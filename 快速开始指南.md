# 人声分离API - 快速开始指南

## 重要说明

**文件位置：** 所有文件都在 `src/` 目录下
- `vocals_separate.py` - 核心分离函数
- `separate_server.py` - Flask服务器
- `start_server.bat` - Windows启动脚本

## 快速启动（推荐）

### 方式1：使用启动脚本（Windows）

1. 双击运行 `src/start_server.bat`
2. 脚本会自动：
   - 安装flask依赖
   - 下载模型文件（如果没有）
   - 启动服务器

3. 或者使用项目根目录的 `start_separation_server.bat` 进行交互式操作

### 方式2：手动启动

1. **安装依赖：**
```bash
cd src
pip install flask flask-cors
```

2. **下载模型（首次使用）：**
```bash
cd src
python download_models.py
```

3. **启动服务器：**
```bash
cd src
python separate_server.py --host 0.0.0.0 --port 5000
```

## 服务器启动成功后

- **服务器地址：** http://localhost:5000
- **健康检查：** http://localhost:5000/health
- **服务器信息：** http://localhost:5000/info

## API调用示例

### Python调用
```python
import requests

url = 'http://localhost:5000/separate'
files = {'file': open('test.mp3', 'rb')}

response = requests.post(url, files=files)
result = response.json()

if result['success']:
    print(f"人声URL: {result['vocals_url']}")
    print(f"伴奏URL: {result['instrumental_url']}")
    
    # 下载文件
    vocals = requests.get(f"http://localhost:5000{result['vocals_url']}")
    with open('vocals.wav', 'wb') as f:
        f.write(vocals.content)
    
    instrumental = requests.get(f"http://localhost:5000{result['instrumental_url']}")
    with open('instrumental.wav', 'wb') as f:
        f.write(instrumental.content)
else:
    print(f"错误: {result['message']}")
```

### cURL调用
```bash
# 上传文件并分离
curl -X POST -F "file=@test.mp3" http://localhost:5000/separate

# 示例返回结果
{
    "success": true,
    "message": "分离成功",
    "vocals_url": "/download/xxx/test_Vocals.wav",
    "instrumental_url": "/download/xxx/test_Instrumental.wav"
}

# 下载人声
curl http://localhost:5000/download/xxx/test_Vocals.wav -o vocals.wav

# 下载伴奏
curl http://localhost:5000/download/xxx/test_Instrumental.wav -o instrumental.wav
```

## 直接调用函数（不通过API）

如果想在Python代码中直接使用分离功能：

```python
import sys
sys.path.insert(0, 'path/to/AICoverGen/src')

from vocals_separate import separate_vocals

vocals_path, instrumental_path = separate_vocals(
    audio_path='input.mp3',
    output_dir='output',
    model_path=None  # 使用默认模型
)

print(f"人声文件: {vocals_path}")
print(f"伴奏文件: {instrumental_path}")
```

## 文件存储位置

- **上传的临时文件：** `uploads/` 目录（自动清理）
- **分离后的输出：** `separated_output/<session_id>/` 目录
- **模型文件：** `mdxnet_models/` 目录

## 支持的音频格式

- wav, mp3, flac, ogg, m4a, aac, wma
- **最大文件大小：** 200MB

## 常见问题

### Q1: 启动失败，提示 ModuleNotFoundError
**A:** 需要先安装项目依赖。运行：
```bash
pip install -r requirements.txt
```

### Q2: 模型下载失败
**A:** 检查网络连接，或者手动下载模型文件到 `mdxnet_models/` 目录

### Q3: 分离速度慢
**A:** 这是正常现象，音频分离需要一定时间。大型文件可能需要几分钟。如果有GPU会更快。

### Q4: 端口被占用
**A:** 使用 `--port` 参数指定其他端口：
```bash
python separate_server.py --port 5001
```

## 技术细节

- **框架：** Flask 2.3.3
- **分离技术：** MDX-Net (基于ONNX)
- **并发处理：** 支持多线程
- **CORS：** 已启用，可以从前端调用

## 故障排查

1. **检查服务器是否运行：** 访问 http://localhost:5000/health
2. **检查模型是否存在：** 查看 `mdxnet_models/` 目录下是否有 `.onnx` 文件
3. **查看日志：** 服务器终端会显示详细的错误信息

## 停止服务器

在服务器终端按 **Ctrl+C** 停止服务器。

## 完整文档

详细文档请查看：`VOCALS_SEPARATE_API.md`